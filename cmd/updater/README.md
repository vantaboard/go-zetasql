# Updater: build GoogleSQL and copy to internal/ccall

This directory builds the [google/googlesql](https://github.com/google/googlesql) C++ tree and copies it (plus Bazel output and external deps) into the repo's `internal/ccall`. That tree is not committed; consumers get it via the **installer** (pre-built tarballs) or by running this updater.

## No submodule

GoogleSQL is **not** a submodule. It is cloned at build time into `./googlesql` (gitignored), then the Docker image is built and the updater copies files into `internal/ccall`.

## Build (local or CI)

1. **Clone googlesql** at the pinned ref in `UPSTREAM_COMMIT` (e.g. `2022.02.01`), or override with `GOOGLESQL_COMMIT`:

   ```bash
   make clone-googlesql
   # Or at a specific tag or commit:
   make clone-googlesql GOOGLESQL_COMMIT=2022.02.01
   ```

2. **Build and export** (Docker + Bazel):

   ```bash
   make build   # depends on clone-googlesql
   make export
   ```

   The export must complete successfully so that Bazel-generated headers (e.g. `resolved_ast.h`, `*.pb.h`) are present in the cache. Without them, `make build` from the repo root will fail with missing-header errors.

3. **Copy to internal/ccall**:

   ```bash
   make update
   ```

   After copying, the updater **applies patches** to upstream files (e.g. redefinition fixes in `type.cc`, `resolver_query.cc`, include guards in `public_suffix_list_data.h`) and **writes stub headers** (farmhash, differential_privacy algorithms) under `internal/ccall`. So fixes and stubs are preserved every time you run `make update` or repopulate ccall.

4. **Generate Go bindings** (from repo root):

   ```bash
   cd ../..
   make generate
   ```

5. **Build the Go module** (from repo root):

   ```bash
   make build
   ``` To push pre-built artifacts, run the release-assets workflow (it clones googlesql, builds, and uploads the tarball).

## Required artifacts

After `make export` and `make update`, the updater verifies that key generated files exist under `internal/ccall`. The exact list is in [main.go](main.go) (search for `requiredFiles`). It includes:

- **resolved_ast.h** – `go-googlesql/resolved_ast/resolved_ast.h` (generated by Bazel from templates in `zetasql/resolved_ast/`).
- **Protos** – e.g. `go-googlesql/proto/*.pb.h`; generated by Bazel and required for the CGo build.

These files are produced by the Bazel targets built in [export.sh](export.sh) (e.g. `//zetasql/public:sql_formatter`, `//zetasql/resolved_ast:resolved_ast`). If the upstream BUILD layout or target names change, update export.sh and the `requiredFiles` list in main.go so the pipeline stays complete.

## Inspecting the cache

You can run an interactive shell in the built image to inspect the raw cache (e.g. Bazel output under `/tmp` after `export`):

```bash
docker run -it --rm zetasql
```

## Removing the old submodule (one-time)

If you still have the old `cmd/updater/zetasql` submodule in your clone:

```bash
git submodule deinit cmd/updater/zetasql
git rm cmd/updater/zetasql
rm -rf .git/modules/cmd/updater/zetasql
```

Then use `clone-googlesql` as above.
